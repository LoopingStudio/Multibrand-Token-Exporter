<!DOCTYPE html>
<html>
<head>
  <style>
    /* --- VARIABLES & RESET --- */
    :root {
      --primary: #7B61FF;
      --primary-hover: #6344E8;
      --bg-app: #F5F6F8;
      --bg-card: #FFFFFF;
      --text-main: #333333;
      --text-sub: #888888;
      --border: #E0E0E0;
      --danger: #FF4D4D;
      --danger-bg: #FFE5E5;
      --radius: 8px;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-color: var(--bg-app);
      color: var(--text-main);
      margin: 0;
      padding: 20px;
      box-sizing: border-box;
    }

    /* --- HEADER --- */
    .header {
      display: flex; align-items: center; gap: 12px; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid #E0E0E0;
    }
    .logo-svg { width: 32px; height: 32px; fill: var(--primary); }
    h1 { font-size: 18px; font-weight: 700; margin: 0; letter-spacing: -0.02em; }

    /* --- CARDS --- */
    .card {
      background: var(--bg-card);
      border-radius: var(--radius);
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
      padding: 16px;
      margin-bottom: 16px;
      border: 1px solid var(--border);
    }
    .section-title {
      font-size: 11px; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-sub); font-weight: 700; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center;
    }

    /* --- FORMS --- */
    label { display: block; font-size: 12px; font-weight: 600; margin-bottom: 6px; }

    /* Style par défaut pour les Selects */
    select {
      width: 100%; padding: 10px 12px; font-size: 13px;
      border: 1px solid var(--border); border-radius: 6px;
      background-color: #FAFAFA; color: var(--text-main); outline: none;
      box-sizing: border-box; margin-bottom: 12px; appearance: none;
      background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23999%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
      background-repeat: no-repeat; background-position: right 12px top 50%; background-size: 8px auto;
    }
    select:focus { border-color: var(--primary); background-color: #fff; }

    /* Style spécifique pour l'input Nom de Marque (pas de flèche) */
    .input-text {
      width: 100%; padding: 10px 12px; font-size: 14px; font-weight: 600;
      border: 1px solid var(--border); border-radius: 6px;
      background-color: #fff; color: var(--text-main); outline: none;
      box-sizing: border-box; transition: all 0.2s;
    }
    .input-text:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(123, 97, 255, 0.1); }

    /* --- BRAND ROWS --- */
    .brand-row {
      background: #F8F9FA; border: 1px solid var(--border); border-radius: 8px;
      padding: 16px; margin-bottom: 12px;
    }
    .brand-header {
      display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; gap: 10px;
    }

    /* Bouton Supprimer */
    .btn-delete {
      background: transparent; color: var(--danger);
      border: 1px solid transparent; border-radius: 4px;
      padding: 6px 12px; font-size: 12px; font-weight: 600; cursor: pointer;
      transition: all 0.2s; white-space: nowrap;
    }
    .btn-delete:hover { background: var(--danger-bg); border-color: rgba(255, 77, 77, 0.2); }

    /* Grid Layout */
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }

    .col-header {
      font-size: 11px; font-weight: 700; color: var(--text-sub); margin-bottom: 8px;
      display: flex; align-items: center; gap: 6px;
    }

    /* --- SOURCE INPUT GROUP (La correction magique) --- */
    .source-group {
        position: relative;
        margin-top: 20px; /* Espace pour le label flottant */
    }

    .source-label {
        position: absolute;
        top: -8px; left: 12px;
        background: #F8F9FA; /* Même couleur que le fond de la row pour masquer la bordure */
        padding: 0 4px;
        font-size: 10px; font-weight: 600; color: var(--primary);
        z-index: 2;
    }

    .input-wrapper {
        position: relative;
        display: flex; align-items: stretch;
    }

    .color-bar {
        width: 3px;
        background: var(--primary);
        border-top-left-radius: 6px;
        border-bottom-left-radius: 6px;
        position: absolute; left: 0; top: 0; bottom: 0; z-index: 1;
    }

    /* Ajustement du select quand il a la barre colorée */
    .select-with-bar {
        margin-bottom: 0; /* On gère la margin sur le groupe */
        border-left: none; /* La barre remplace la bordure gauche */
        padding-left: 12px; /* Un peu plus d'espace */
    }

    /* --- BUTTONS FOOTER --- */
    .btn { cursor: pointer; border: none; border-radius: 6px; font-weight: 600; display: inline-flex; align-items: center; justify-content: center; transition: all 0.2s; }
    .btn-primary { background: var(--primary); color: white; width: 100%; padding: 14px; font-size: 14px; box-shadow: 0 4px 6px rgba(123, 97, 255, 0.2); }
    .btn-primary:hover { background: var(--primary-hover); transform: translateY(-1px); }
    .btn-text { background: transparent; color: var(--primary); padding: 4px 8px; font-size: 13px; }
    .btn-text:hover { background: rgba(123, 97, 255, 0.1); }
    .hidden { display: none !important; }
    .loader { text-align: center; color: var(--text-sub); padding: 40px; font-size: 13px; }
    /* --- CSS ALIGNEMENT FLÈCHE --- */
    
    .mapping-row {
        display: flex;
        align-items: flex-end; /* Aligne tout sur le bas (la base des inputs) */
        gap: 12px;
    }

    .arrow-separator {
        /* MAGIE ICI : On donne à la flèche la hauteur exacte de l'input */
        height: 38px; 
        
        /* On utilise flex pour centrer le glyphe "→" dans cette boîte de 38px */
        display: flex;
        align-items: center; 
        justify-content: center;
        
        /* Style */
        color: #CCC;
        font-size: 16px;
        font-weight: bold;
    }

    /* Force les selects du mapping à ne pas avoir de marge en bas pour coller à la ligne */
    .mapping-row select, 
    .mapping-row .compact-select {
        margin-bottom: 0 !important;
    }
    .input-group {
        flex: 1;
        min-width: 0;
    }
    .tiny-label {
        font-size: 10px;
        font-weight: 700;
        color: var(--text-sub);
        margin-bottom: 6px;
        text-transform: uppercase;
    }
    /* Optionnel : pour que les selects du haut soient aussi compacts */
    .compact-select {
        padding: 8px 12px !important;
        font-size: 13px !important;
        height: 36px; /* Hauteur fixe pour alignement parfait */
    }
</style>
</head>
<body>

  <div id="loading" class="loader">
    <svg class="logo-svg" style="animation: spin 2s linear infinite; width:24px; height:24px; margin-bottom:10px;" viewBox="0 0 24 24">
        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/><path d="M12 6c-3.31 0-6 2.69-6 6s2.69 6 6 6 6-2.69 6-6-2.69-6-6-6zm0 10c-2.21 0-4-1.79-4-4s1.79-4 4-4 4 1.79 4 4-1.79 4-4 4z"/>
    </svg>
    <br><span id="loadingText"></span>
  </div>

  <div id="main" class="hidden">
    
    <div class="header">
        <svg class="logo-svg" viewBox="0 0 89 96" xmlns="http://www.w3.org/2000/svg">
            <defs>
                <linearGradient id="paint0_linear_8612_35" x1="50.0308" y1="6.39642" x2="50.0308" y2="88.9941" gradientUnits="userSpaceOnUse">
                    <stop stop-color="#D6B2FF"/>
                    <stop offset="1" stop-color="#6609D1"/>
                </linearGradient>
                <linearGradient id="paint1_linear_8612_35" x1="44.5" y1="0" x2="44.5" y2="95.3906" gradientUnits="userSpaceOnUse">
                    <stop stop-color="#B488FF"/>
                    <stop offset="1" stop-color="#48208D"/>
                </linearGradient>
            </defs>
            <path d="M41.2632 47.7675C36.8974 55.3932 37.2121 64.4225 41.3052 71.5331V47.871C41.3684 56.6227 46.1457 64.2467 53.2222 68.3427L61.9526 83.4628C57.9004 83.4662 53.794 82.4419 50.0327 80.2704C46.2712 78.0988 43.328 75.0506 41.3052 71.5361V88.9941C37.7941 86.9713 34.7493 84.0318 32.5776 80.2704C30.4026 76.509 29.3809 72.3985 29.3843 68.3427L41.2632 47.7675ZM41.3052 47.871C41.3048 47.8141 41.3023 47.7572 41.3022 47.7001L41.2632 47.7675C41.2765 47.7443 41.2888 47.7204 41.3022 47.6972V47.6962C33.6625 52.1075 29.3945 60.1104 29.3843 68.3427L20.6538 83.4628C18.6244 79.9552 17.4575 75.886 17.4575 71.5429C17.4575 58.3719 28.1316 47.6968 41.3022 47.6953H41.3032C41.3038 47.6942 41.3046 47.6933 41.3052 47.6923V47.871ZM77.0728 27.0478C77.0761 31.1 76.0518 35.2064 73.8804 38.9677V38.9716C71.7098 42.7313 68.6632 45.6725 65.1509 47.6953H82.604C80.5812 51.2064 77.6418 54.2511 73.8804 56.4228C70.1189 58.5978 66.0084 59.6195 61.9526 59.6161C53.7209 59.606 45.7215 55.3368 41.3101 47.6982H41.3071C45.7184 55.3376 53.7204 59.606 61.9526 59.6161L77.0728 68.3466C73.5651 70.376 69.4993 71.5429 65.1528 71.5429C60.8061 71.5429 56.7329 70.3757 53.2251 68.3427L41.3071 47.6982H41.3052C50.1304 47.6982 57.8292 42.9021 61.9526 35.7783L77.0728 27.0478ZM41.3101 47.6982C48.9486 52.1051 58.0094 51.8011 65.1411 47.6982H41.3101ZM20.6509 11.9277C24.7066 11.9243 28.8133 12.9485 32.5747 15.1201C36.3362 17.2917 39.2794 20.3399 41.3022 23.8544V47.6953L20.6509 11.9277ZM61.9565 11.9277C63.9859 15.4353 65.1528 19.5045 65.1528 23.8476C65.1528 28.1943 63.9856 32.2675 61.9526 35.7753L41.3081 47.6933V47.6913C48.947 43.2799 53.2149 35.2797 53.2251 27.0478L61.9565 11.9277ZM41.3052 6.39642C44.8163 8.4192 47.8611 11.3587 50.0327 15.1201V15.124C52.2076 18.8853 53.2284 22.9951 53.2251 27.0507L41.3218 47.6679C45.7144 40.033 45.4061 30.9828 41.3052 23.8583V6.39642Z" fill="url(#paint0_linear_8612_35)"/>
            <path d="M8.73047 56.4229C15.3119 45.022 29.8935 41.1112 41.2988 47.6924C28.1299 47.6958 17.4582 58.3694 17.458 71.5391C17.458 75.8815 18.6235 79.9507 20.6523 83.458L29.3818 68.3428C29.3785 72.3952 30.4026 76.5056 32.5742 80.2705V80.2734C34.7459 84.0349 37.7906 86.9743 41.3018 88.9971V95.3906C32.4768 95.3906 24.7749 90.5907 20.6514 83.4639L17.458 88.9971C6.05523 82.4145 2.14467 67.8291 8.73047 56.4229ZM53.2256 68.3428C56.7367 70.3757 60.8058 71.5429 65.1523 71.543C69.4956 71.543 73.5655 70.3762 77.0732 68.3467L82.6104 71.543C78.1962 79.1873 70.19 83.4548 61.957 83.4619L65.1523 88.9971C57.5076 93.4147 48.4386 93.1069 41.3047 88.9971V71.5361L41.3086 71.5332C43.3314 75.0476 46.2714 78.095 50.0361 80.2666C53.7969 82.4378 57.9025 83.462 61.9541 83.459L53.2256 68.3428ZM89 47.6953C89 56.5206 84.2004 64.2233 77.0732 68.3467L61.9531 59.6152C66.0053 59.6186 70.1152 58.5944 73.8799 56.4229H73.8838C77.6452 54.2512 80.5846 51.2064 82.6074 47.6953H89ZM17.458 6.39355C25.1026 1.97603 34.1708 2.28382 41.3047 6.39355V23.8574C39.2819 20.3431 36.3427 17.2956 32.5781 15.124C28.8136 12.9526 24.7073 11.9275 20.6553 11.9307L41.3027 47.6924H41.3047V47.6953L0 23.8477C4.41403 16.2035 12.4197 11.9351 20.6523 11.9277L17.458 6.39355ZM65.1523 6.38965C72.7961 10.8034 77.0644 18.8089 77.0723 27.041L82.6074 23.8477C87.0251 31.4923 86.7172 40.5614 82.6074 47.6953H65.1455L65.1426 47.6924C68.6571 45.6696 71.7053 42.7297 73.877 38.9648C76.0483 35.2039 77.0715 31.0977 77.0684 27.0459L61.9531 35.7754C63.9861 32.2642 65.1523 28.191 65.1523 23.8477C65.1523 19.5045 63.9855 15.4354 61.9561 11.9277L65.1523 6.38965ZM41.3047 0C50.13 0 57.8326 4.80053 61.9561 11.9277L53.2256 27.0479C53.229 22.9955 52.2039 18.885 50.0322 15.1201V15.1172C47.8606 11.3557 44.8159 8.41637 41.3047 6.39355V0Z" fill="url(#paint1_linear_8612_35)"/>
            <path d="M41.3047 71.5365C37.1983 64.4027 36.894 55.337 41.3047 47.6957V71.5365ZM29.3848 68.3432C29.3949 60.11 33.6636 52.1067 41.3047 47.6957L29.3848 68.3432ZM53.2256 68.3432C46.1019 64.2198 41.3048 56.5208 41.3047 47.6957L53.2256 68.3432ZM61.9531 59.6156C53.7198 59.6055 45.7157 55.337 41.3047 47.6957L61.9531 59.6156ZM65.1455 47.6957C58.0116 51.8019 48.9459 52.1066 41.3047 47.6957H65.1455ZM41.3047 23.8549C45.4112 30.9888 45.7156 40.0544 41.3047 47.6957V23.8549ZM53.2256 27.0473C53.2154 35.2806 48.9461 43.2848 41.3047 47.6957L53.2256 27.0473ZM61.9531 35.7748C57.8297 42.8986 50.13 47.6957 41.3047 47.6957L61.9531 35.7748Z" fill="white"/>
        </svg>
        <h1 id="mainTitle"></h1>
    </div>

    <div class="card">
      <div class="section-title">
          <span id="mappingTitle"></span>
      </div>

      <div class="mapping-row">
          <div class="input-group">
              <div class="tiny-label" id="sourceLabel"></div>
              <select id="primitiveCollectionSelect" class="compact-select"></select>
          </div>

          <div class="arrow-separator">→</div>

          <div class="input-group">
              <div class="tiny-label" id="targetLabel"></div>
              <select id="tokenCollectionSelect" class="compact-select"></select>
          </div>
      </div>
    </div>

    <div class="card">
      <div class="section-title">
        <span id="brandsTitle"></span>
        <button class="btn btn-text" id="addBrandBtn"></button>
      </div>
      <div id="brandsContainer"></div>
    </div>

    <button id="exportBtn" class="btn btn-primary"></button>
  </div>

  <script>
    let collectionsData = [];

    /* --- i18n TRANSLATIONS --- */
    const translations = {
      fr: {
        loading: "Chargement des collections...",
        title: "Multibrand Token Exporter",
        mappingGlobal: "Mapping Global",
        sourceLabel: "Source (Primitives)",
        targetLabel: "Cible (Sémantique)",
        brandsTitle: "Marques & Mapping",
        addButton: "+ Ajouter",
        exportButton: "Exporter le JSON",
        brandPlaceholder: "Nom de la Marque (ex: Legacy)",
        deleteButton: "Supprimer",
        lightMode: "LIGHT MODE",
        darkMode: "DARK MODE",
        sourceTag: "Source",
        newBrand: "Nouvelle Marque",
        fileName: "multibrand_tokens.json"
      },
      en: {
        loading: "Loading collections...",
        title: "Multibrand Token Exporter",
        mappingGlobal: "Global Mapping",
        sourceLabel: "Source (Primitives)",
        targetLabel: "Target (Semantic)",
        brandsTitle: "Brands & Mapping",
        addButton: "+ Add",
        exportButton: "Export JSON",
        brandPlaceholder: "Brand Name (e.g., Legacy)",
        deleteButton: "Delete",
        lightMode: "LIGHT MODE",
        darkMode: "DARK MODE",
        sourceTag: "Source",
        newBrand: "New Brand",
        fileName: "multibrand_tokens.json"
      }
    };

    // Detect user language
    const userLang = (navigator.language || navigator.userLanguage || 'en').split('-')[0];
    const t = translations[userLang] || translations.en;

    /* --- APPLY TRANSLATIONS --- */
    function applyTranslations() {
      document.getElementById('loadingText').textContent = t.loading;
      document.getElementById('mainTitle').textContent = t.title;
      document.getElementById('mappingTitle').textContent = t.mappingGlobal;
      document.getElementById('sourceLabel').textContent = t.sourceLabel;
      document.getElementById('targetLabel').textContent = t.targetLabel;
      document.getElementById('brandsTitle').textContent = t.brandsTitle;
      document.getElementById('addBrandBtn').textContent = t.addButton;
      document.getElementById('exportBtn').textContent = t.exportButton;
    }

    /* --- INITIALISATION --- */
    window.onload = () => {
      applyTranslations();
      parent.postMessage({ pluginMessage: { type: 'init', lang: userLang } }, '*');
    };

    window.onmessage = (event) => {
      const msg = event.data.pluginMessage;

      if (msg.type === 'init-data') {
        collectionsData = msg.collections;
        setupUI();
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('main').classList.remove('hidden');
      }

      if (msg.type === 'download-json') {
        const jsonString = JSON.stringify(msg.data, null, 2);
        const blob = new Blob([jsonString], { type: "application/json" });
        const reader = new FileReader();
        reader.readAsDataURL(blob);
        reader.onload = () => {
             const link = document.createElement("a");
             link.href = reader.result;
             link.download = t.fileName;
             link.click();
        };
      }
    };

    /* --- LOGIC --- */
    function setupUI() {
      const tokenSelect = document.getElementById('tokenCollectionSelect');
      const primSelect = document.getElementById('primitiveCollectionSelect');

      // 1. Remplir les dropdowns
      collectionsData.forEach(c => {
        tokenSelect.add(new Option(c.name, c.id));
        primSelect.add(new Option(c.name, c.id));
      });

      // 2. Auto-sélection
      const primFound = collectionsData.find(c => c.name.startsWith("_") || c.name.toLowerCase().includes("primitive"));
      if(primFound) primSelect.value = primFound.id;

      const modeFound = collectionsData.find(c => c.name.toLowerCase().includes("mode") || c.name.toLowerCase().includes("token"));
      if(modeFound) tokenSelect.value = modeFound.id;

      // 3. Auto-génération des marques
      populateBrandsFromPrimitives();

      // Listeners
      primSelect.addEventListener('change', populateBrandsFromPrimitives);
      tokenSelect.addEventListener('change', () => {
         document.querySelectorAll('.brand-row').forEach(row => updateTokenDropdownsSmartly(row));
      });
    }

    function populateBrandsFromPrimitives() {
        const primId = document.getElementById('primitiveCollectionSelect').value;
        const primColl = collectionsData.find(c => c.id === primId);
        const container = document.getElementById('brandsContainer');
        
        container.innerHTML = ""; 

        if (!primColl) return;

        primColl.modes.forEach(mode => {
            addBrandRow(mode.name, mode.modeId);
        });
    }

    function addBrandRow(name = "", preselectedPrimitiveModeId = null) {
      const container = document.getElementById('brandsContainer');
      const div = document.createElement('div');
      div.className = 'brand-row';
      
      div.innerHTML = `
        <div class="brand-header">
           <input type="text" class="input-text brand-name-input" value="${name}" placeholder="${t.brandPlaceholder}">

           <button class="btn-delete" onclick="this.closest('.brand-row').remove()">${t.deleteButton}</button>
        </div>

        <div class="grid-2">
            <div class="col">
                <div class="col-header">
                    <span style="width:8px; height:8px; background:#FFD700; border-radius:50%;"></span>
                    ${t.lightMode}
                </div>

                <select class="sel-light-token"></select>

                <div class="source-group">
                    <span class="source-label" style="color:var(--text-sub);">${t.sourceTag}</span>
                    <div class="input-wrapper">
                        <div class="color-bar" style="background:#FFD700;"></div>
                        <select class="sel-light-prim select-with-bar"></select>
                    </div>
                </div>
            </div>

            <div class="col">
                <div class="col-header">
                    <span style="width:8px; height:8px; background:#4801A0; border-radius:50%;"></span>
                    ${t.darkMode}
                </div>

                <select class="sel-dark-token"></select>

                <div class="source-group">
                    <span class="source-label" style="color:var(--text-sub);">${t.sourceTag}</span>
                    <div class="input-wrapper">
                        <div class="color-bar" style="background:#4801A0;"></div>
                        <select class="sel-dark-prim select-with-bar"></select>
                    </div>
                </div>
            </div>
        </div>
      `;
      container.appendChild(div);
      updateRowDropdowns(div, preselectedPrimitiveModeId);
    }

    function updateRowDropdowns(rowDiv, targetPrimitiveModeId) {
        const tokenId = document.getElementById('tokenCollectionSelect').value;
        const primId = document.getElementById('primitiveCollectionSelect').value;

        const tokenColl = collectionsData.find(c => c.id === tokenId);
        const primColl = collectionsData.find(c => c.id === primId);

        // Remplir Primitives
        const primSelects = [rowDiv.querySelector('.sel-light-prim'), rowDiv.querySelector('.sel-dark-prim')];
        primSelects.forEach(sel => {
            sel.innerHTML = "";
            if (primColl) {
                primColl.modes.forEach(m => sel.add(new Option(m.name, m.modeId)));
                if (targetPrimitiveModeId) sel.value = targetPrimitiveModeId;
            }
        });
        
        // Remplir Tokens (Smart)
        updateTokenDropdownsSmartly(rowDiv);
    }

    function updateTokenDropdownsSmartly(rowDiv) {
        const tokenId = document.getElementById('tokenCollectionSelect').value;
        const tokenColl = collectionsData.find(c => c.id === tokenId);
        const brandNameInput = rowDiv.querySelector('.brand-name-input');
        const brandName = brandNameInput ? brandNameInput.value.toLowerCase() : "";

        const lightSel = rowDiv.querySelector('.sel-light-token');
        const darkSel = rowDiv.querySelector('.sel-dark-token');

        [lightSel, darkSel].forEach(sel => sel.innerHTML = "");
        if (!tokenColl) return;

        tokenColl.modes.forEach(m => {
            lightSel.add(new Option(m.name, m.modeId));
            darkSel.add(new Option(m.name, m.modeId));
        });

        // --- SMART SELECT LOGIC ---

        // 1. RECHERCHE LIGHT
        // Priorité A : Contient le nom de la marque ET ("light" ou pas "dark")
        let foundLight = tokenColl.modes.find(m => {
            const n = m.name.toLowerCase();
            return n.includes(brandName) && (n.includes("light") || !n.includes("dark"));
        });

        // Priorité B (Fallback) : Si pas trouvé, prend le premier qui contient "light" (ou qui n'est pas "dark")
        if (!foundLight) {
            foundLight = tokenColl.modes.find(m => {
                const n = m.name.toLowerCase();
                return n.includes("light") || !n.includes("dark");
            });
        }
        
        if (foundLight) lightSel.value = foundLight.modeId;


        // 2. RECHERCHE DARK
        // Priorité A : Contient le nom de la marque ET "dark"
        let foundDark = tokenColl.modes.find(m => {
            const n = m.name.toLowerCase();
            return n.includes(brandName) && n.includes("dark");
        });

        // Priorité B (Fallback) : Si pas trouvé, prend le premier qui contient "dark"
        if (!foundDark) {
            foundDark = tokenColl.modes.find(m => m.name.toLowerCase().includes("dark"));
        }

        if (foundDark) darkSel.value = foundDark.modeId;
    }

    document.getElementById('addBrandBtn').onclick = () => addBrandRow(t.newBrand);

    document.getElementById('exportBtn').onclick = () => {
        const brands = [];
        document.querySelectorAll('.brand-row').forEach(row => {
            brands.push({
                name: row.querySelector('.brand-name-input').value || "Unnamed",
                light: {
                    modeId: row.querySelector('.sel-light-token').value,
                    primitiveModeId: row.querySelector('.sel-light-prim').value
                },
                dark: {
                    modeId: row.querySelector('.sel-dark-token').value,
                    primitiveModeId: row.querySelector('.sel-dark-prim').value
                }
            });
        });

        const config = {
            tokenCollectionId: document.getElementById('tokenCollectionSelect').value,
            primitiveCollectionId: document.getElementById('primitiveCollectionSelect').value,
            brands: brands
        };

        parent.postMessage({ pluginMessage: { type: 'export', config } }, '*');
    };
  </script>
</body>
</html>